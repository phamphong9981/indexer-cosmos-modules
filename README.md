# Horoscope v2 - Cosmos Blockchain Indexer

Horoscope v2 l√† phi√™n b·∫£n ti·∫øp theo c·ªßa Horoscope, m·ªôt d·ªãch v·ª• l·∫≠p ch·ªâ m·ª•c to√†n di·ªán cho c√°c blockchain d·ª±a tr√™n Cosmos. H·ªá th·ªëng thu th·∫≠p d·ªØ li·ªáu t·ª´ blockchain v√† l·∫≠p ch·ªâ m·ª•c v√†o PostgreSQL, cung c·∫•p kh·∫£ nƒÉng t√¨m ki·∫øm v√† truy v·∫•n d·ªØ li·ªáu hi·ªáu qu·∫£ thay v√¨ truy v·∫•n tr·ª±c ti·∫øp t·ª´ LCD ho·∫∑c RPC.

## üåü T√≠nh nƒÉng ch√≠nh

- **L·∫≠p ch·ªâ m·ª•c to√†n di·ªán**: H·ªó tr·ª£ t·∫•t c·∫£ c√°c module Cosmos SDK v√† c√°c extension
- **H·ªó tr·ª£ EVM**: L·∫≠p ch·ªâ m·ª•c ƒë·∫ßy ƒë·ªß cho c√°c blockchain t∆∞∆°ng th√≠ch EVM nh∆∞ Evmos
- **CosmWasm Integration**: H·ªó tr·ª£ smart contract v√† c√°c chu·∫©n token (CW20, CW721)
- **Real-time Processing**: X·ª≠ l√Ω d·ªØ li·ªáu blockchain theo th·ªùi gian th·ª±c
- **GraphQL API**: API m·∫°nh m·∫Ω th√¥ng qua Hasura
- **Microservices Architecture**: Ki·∫øn tr√∫c c√≥ th·ªÉ m·ªü r·ªông v·ªõi Moleculer

## üèóÔ∏è Ki·∫øn tr√∫c t·ªïng quan

```mermaid
graph TB
    subgraph "Blockchain Networks"
        A[Cosmos SDK Chains]
        B[EVM Compatible Chains]
        C[CosmWasm Chains]
    end
    
    subgraph "Horoscope v2 Core"
        D[Block Crawler]
        E[Transaction Processor]
        F[Event Handler]
        G[Smart Contract Indexer]
    end
    
    subgraph "Specialized Services"
        H[EVM Module]
        I[CosmWasm Module]
        J[IBC Module]
        K[Governance Module]
    end
    
    subgraph "Data Layer"
        L[(PostgreSQL)]
        M[Redis Queue]
    end
    
    subgraph "API Layer"
        N[Hasura GraphQL]
        O[REST API]
    end
    
    A --> D
    B --> D
    C --> D
    
    D --> E
    E --> F
    F --> G
    
    G --> H
    G --> I
    G --> J
    G --> K
    
    H --> L
    I --> L
    J --> L
    K --> L
    
    E --> M
    L --> N
    N --> O
```

## üöÄ C√°c d·ªãch v·ª• ƒë∆∞·ª£c h·ªó tr·ª£

### Core Services
- [**crawl-block**](./docs/services/crawl-block/README.md): Thu th·∫≠p block t·ª´ network v√† l∆∞u v√†o DB
- [**crawl-transaction**](./docs/services/crawl-transaction/README.md): X·ª≠ l√Ω giao d·ªãch trong block v√† decode
- [**crawl-account**](./docs/services/crawl-account/README.md): Qu·∫£n l√Ω t√†i kho·∫£n v√† s·ªë d∆∞
- [**handle-vote**](./docs/services/handle-vote/README.md): X·ª≠ l√Ω tin nh·∫Øn vote trong governance

### Governance & Validation
- [**crawl-proposal**](./docs/services/crawl-proposal/README.md): Thu th·∫≠p proposal v√† tr·∫°ng th√°i
- [**crawl-validator**](./docs/services/crawl-validator/README.md): Qu·∫£n l√Ω validator v√† signing info

### Smart Contract & Token
- [**crawl-cosmwasm**](./docs/services/crawl-cosmwasm/README.md): X·ª≠ l√Ω CosmWasm smart contract
- [**EVM Module**](./docs/services/evm/README.md): H·ªó tr·ª£ ƒë·∫ßy ƒë·ªß EVM (Evmos integration)
  - ERC-20 token indexing
  - ERC-721 NFT processing
  - Smart contract verification
  - Proxy contract support

### Specialized Modules
- [**feegrant**](./docs/services/feegrant/README.md): X·ª≠ l√Ω fee grant module
- [**IBC**](./docs/services/ibc/README.md): Inter-Blockchain Communication
- [**crawl-genesis**](./docs/services/crawl-genesis/README.md): X·ª≠ l√Ω state t·ª´ genesis

## üåê M·∫°ng ƒë∆∞·ª£c h·ªó tr·ª£

Hi·ªán t·∫°i h·ªó tr·ª£ c√°c network ƒë∆∞·ª£c x√¢y d·ª±ng b·∫±ng Cosmos SDK v0.45.1 tr·ªü l√™n:

### Mainnet
- **Aura Network**: Layer-1 blockchain v·ªõi NFT focus
- **Evmos**: EVM-compatible Cosmos chain
- **Sei Network**: High-performance DeFi chain

### Testnet
- **Aura Testnet (Euphoria)**
- **Evmos Testnet**
- **Sei Testnet**

> **T√¨m Horoscope v1?** Repository Horoscope v1 ƒë√£ ƒë∆∞·ª£c archive t·∫°i [`Horoscope v1`](https://github.com/aura-nw/Horoscope).

## üõ†Ô∏è C√¥ng ngh·ªá s·ª≠ d·ª•ng

- **Backend**: Node.js v·ªõi TypeScript
- **Framework**: [Moleculer.js](https://moleculer.services/) microservices
- **Database**: PostgreSQL v·ªõi partitioning
- **Queue**: Bull/BullMQ v·ªõi Redis
- **API**: Hasura GraphQL Engine
- **Blockchain Interaction**: CosmJS, Viem, AuraJS

## üìä Schema Database

Xem chi ti·∫øt schema database [t·∫°i ƒë√¢y](./docs/database_schema.md)

### B·∫£ng ch√≠nh
- **Blockchain Core**: block, transaction, event, message
- **Account Management**: account, account_balance, account_statistics
- **Governance**: proposal, vote, validator
- **Smart Contract**: smart_contract, contract_code
- **EVM Support**: evm_transaction, evm_event, evm_internal_transaction, erc20_contract, erc721_token
- **IBC**: ibc_channel, ibc_connection, ibc_client
- **Feegrant**: feegrant, feegrant_history
- **Cosmwasm**: smart_contract, smart_contract_events, cw20(cw721)_contracts, cw20(cw721)_activities

## üöÄ C√†i ƒë·∫∑t v√† Ch·∫°y

### Y√™u c·∫ßu h·ªá th·ªëng
- Node.js 18+
- PostgreSQL 14+
- Redis 6+
- Docker & Docker Compose

### 1. C√†i ƒë·∫∑t dependencies

Horoscope s·ª≠ d·ª•ng private package [aurajs](https://github.com/aura-nw/aurajs). T·∫°o Personal Access Token c√≥ quy·ªÅn ƒë·ªçc package:

```bash
# T·∫°o .npmrc file
@aura-nw:registry=https://npm.pkg.github.com/aura-nw
//npm.pkg.github.com/:_authToken=YOUR_GITHUB_TOKEN
```

### 2. Kh·ªüi ƒë·ªông infrastructure

```bash
# Kh·ªüi ƒë·ªông PostgreSQL, Redis, Hasura
docker-compose up -d

# C√†i ƒë·∫∑t dependencies
npm install
```

### 3. C·∫•u h√¨nh

```bash
# T·∫°o file environment
cp .env.sample .env

# C·∫•u h√¨nh network
cp network.json.sample network.json

# C·∫•u h√¨nh chain
cp config.json.sample config.json
```

### 4. Migration Database

```bash
# Ch·∫°y migration
npm run migrate

# Seed data (optional)
npm run seed
```

### 5. Kh·ªüi ƒë·ªông services

```bash
# Development mode v·ªõi hot-reload
npm run dev

# Production mode
npm run build
npm run start
```

## ‚öôÔ∏è C·∫•u h√¨nh

### Environment Variables (.env)
```bash
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/horoscope

# Redis
REDIS_URL=redis://localhost:6379

# Blockchain RPC
COSMOS_RPC_URL=https://rpc.cosmos.network
EVM_RPC_URL=https://eth.public-rpc.com

# Hasura
HASURA_GRAPHQL_ENDPOINT=http://localhost:8080/v1/graphql
```

### Network Configuration (network.json)
```json
{
  "aura": {
    "chainId": "xstaxy-1",
    "lcd": "https://lcd.aura.network",
    "rpc": "https://rpc.aura.network",
    "database": "aura_mainnet"
  },
  "evmos": {
    "chainId": "evmos_9001-2",
    "lcd": "https://rest.bd.evmos.org:1317",
    "rpc": "https://tendermint.bd.evmos.org:26657",
    "evmRpc": "https://eth.bd.evmos.org:8545",
    "database": "evmos_mainnet"
  }
}
```

### Chain Configuration (config.json)
```json
{
  "chainId": "xstaxy-1",
  "crawlBlock": {
    "blocksPerCall": 100,
    "millisecondCrawl": 5000
  },
  "evm": {
    "enabled": true,
    "crawlEvmBlock": {
      "millisecondCrawl": 3000
    }
  }
}
```

## üîß Hasura Setup

### C√†i ƒë·∫∑t Hasura CLI
```bash
# MacOS
brew install hasura-cli

# Linux
curl -L https://github.com/hasura/graphql-engine/raw/stable/cli/get.sh | bash

# Windows
# Download t·ª´ GitHub releases
```

### Migration Metadata
```bash
# Kh·ªüi t·∫°o Hasura directory
hasura init hasura

# C·∫•u h√¨nh environment
cp .env.hasura.sample hasura/.env

# Export metadata hi·ªán t·∫°i
cd hasura
hasura metadata export

# Apply metadata
hasura metadata apply

# Console
hasura console
```

## üìà Monitoring & Logging

### Health Check Endpoints
- **Service Health**: `GET /health`
- **Database Status**: `GET /health/db`
- **Queue Status**: `GET /health/queue`

### Metrics
- Block processing rate
- Transaction throughput
- Queue depth
- Error rates

### Logging Levels
- **ERROR**: Critical errors
- **WARN**: Warning conditions
- **INFO**: General information
- **DEBUG**: Detailed debug info

## üß™ Testing

```bash
# Unit tests
npm run test

# Integration tests
npm run test:integration

# E2E tests
npm run test:e2e

# Coverage
npm run test:coverage
```

## üìö API Documentation

### GraphQL API
Truy c·∫≠p Hasura Console t·∫°i: `http://localhost:8080`

### Sample Queries

#### L·∫•y th√¥ng tin block m·ªõi nh·∫•t
```graphql
query LatestBlocks {
  block(limit: 10, order_by: {height: desc}) {
    height
    hash
    time
    tx_count
    proposer_address
  }
}
```

#### L·∫•y giao d·ªãch ERC-20
```graphql
query ERC20Transfers {
  erc20_activity(limit: 20, order_by: {height: desc}) {
    height
    tx_hash
    from
    to
    amount
    erc20_contract {
      name
      symbol
      decimals
    }
  }
}
```

## üîí Security

### Best Practices
- Environment variables cho sensitive data
- Database connection pooling
- Rate limiting tr√™n API endpoints
- Input validation v√† sanitization
- Regular security updates

### Access Control
- Service-level authentication
- Database role-based access
- API key management
- Network security groups

## üöÄ Deployment

### Docker Deployment
```bash
# Build image
docker build -t horoscope-v2 .

# Run container
docker run -d \
  --name horoscope-v2 \
  -p 3000:3000 \
  -e DATABASE_URL=postgresql://... \
  horoscope-v2
```

### Kubernetes Deployment
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: horoscope-v2
spec:
  replicas: 3
  selector:
    matchLabels:
      app: horoscope-v2
  template:
    metadata:
      labels:
        app: horoscope-v2
    spec:
      containers:
      - name: horoscope-v2
        image: horoscope-v2:latest
        ports:
        - containerPort: 3000
```

## ü§ù Contributing

### Development Workflow
1. Fork repository
2. T·∫°o feature branch
3. Implement changes
4. Add tests
5. Submit pull request

### Code Standards
- TypeScript strict mode
- ESLint + Prettier
- Conventional commits
- 100% test coverage cho core services

## üìã Scripts

- `npm run dev`: Development mode v·ªõi hot-reload
- `npm run build`: Build production
- `npm run start`: Start production mode
- `npm run lint`: Run ESLint
- `npm run test`: Run tests
- `npm run migrate`: Database migration
- `npm run seed`: Seed database

## üó∫Ô∏è Roadmap

### Q1 2024
- [ ] ERC-1155 support
- [ ] Advanced analytics
- [ ] Performance optimizations

### Q2 2024
- [ ] Multi-chain aggregation
- [ ] Real-time subscriptions
- [ ] Advanced querying features

### Q3 2024
- [ ] Machine learning insights
- [ ] Cross-chain analytics
- [ ] Mobile SDK

## üìÑ License

MIT License - xem [LICENSE](LICENSE) ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.

---
